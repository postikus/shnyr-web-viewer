# Менеджеры (Managers) проекта Shnyr

## Обзор архитектуры

Проект использует модульную архитектуру с менеджерами, каждый из которых отвечает за определенную область функциональности. Все менеджеры работают асинхронно и имеют четко определенные интерфейсы.

---

## LoggerManager

**Назначение:**  
Централизованное логирование в файл с поддержкой разных уровней логирования, временных меток и эмодзи для лучшей читаемости.

**Методы:**
- `Debug(format string, args ...interface{})`  
  Записывает отладочное сообщение.
- `Info(format string, args ...interface{})`  
  Записывает информационное сообщение с эмодзи.
- `Error(format string, args ...interface{})`  
  Записывает сообщение об ошибке.
- `LogError(err error, context string)`  
  Записывает ошибку с дополнительной информацией и контекстом.
- `Close() error`  
  Закрывает файл логов.

**Особенности:**
- Автоматическое создание директории логов
- Ротация логов по датам
- Поддержка эмодзи для визуального разделения типов сообщений
- Потокобезопасность

**Зависимости:**
- Файловая система (для записи логов)

---

## ScreenshotManager

**Назначение:**  
Управляет захватом скриншотов, проверкой качества изображений, поиском координат предметов и обработкой изображений.

**Методы:**
- `CaptureScreenShot() (image.Image, error)`  
  Делает скриншот области с проверкой качества (до 5 попыток при плохом качестве).
- `SaveScreenShot(cfg *config.Config) image.Image`  
  Сохраняет скриншот в файл с учетом отступов.
- `SaveScreenShotFull() image.Image`  
  Сохраняет полный скриншот без обрезки краёв.
- `GetItemListItemsCoordinates() ([]image.Point, error)`  
  Получает координаты всех элементов в списке предметов.
- `CheckButtonActiveByPixel(x, y int) bool`  
  Проверяет активность кнопки по пикселю.
- `CheckScrollExists() bool`  
  Проверяет наличие скролла на изображении.
- `GetPageStatus(config *config.Config) PageStatus`  
  Возвращает полный статус страницы (кнопки + скролл).
- `PerformScreenshotWithScroll(pageStatus PageStatus, config *config.Config) (image.Image, error)`  
  Выполняет скриншот со скроллом.
- `SaveImage(img image.Image, filename string, saveAllScreenshots int, loggerManager *logger.LoggerManager) (string, error)`  
  Сохраняет изображение с настраиваемыми параметрами.
- `CropImageForText(img image.Image, config *config.Config, Button2Active bool) image.Image`  
  Обрезает изображение для текстового анализа.

**Особенности:**
- Проверка качества изображений (RGB каналы ≤ 26)
- Повторные попытки при плохом качестве
- Асинхронная обработка
- Подробное логирование процесса

**Зависимости:**
- Конфиг (`*config.Config`)
- LoggerManager

---

## DatabaseManager

**Назначение:**  
Инкапсулирует работу с базой данных: сохранение результатов OCR, структурированных данных, асинхронные операции.

**Методы:**
- `SaveOCRResultToDB(imagePath, ocrResult, debugInfo, jsonData, rawText string, imageData []byte, cfg *config.Config) (int, error)`  
  Сохраняет результат OCR в базу данных асинхронно.
- `WaitForAsyncOperations()`  
  Ожидает завершения всех асинхронных операций сохранения.
- `SaveStructuredDataBatch(db *sql.DB, ocrResultID int, jsonData string) error`  
  Сохраняет структурированные данные в batch режиме.

**Особенности:**
- Асинхронное сохранение структурированных данных
- Batch обработка для улучшения производительности
- Автоматическое создание таблиц
- Транзакционная безопасность

**Зависимости:**
- SQL-драйвер (MySQL)
- Конфиг
- LoggerManager

---

## OCRManager

**Назначение:**  
Отвечает за распознавание текста на изображениях (OCR), обработку результатов, подготовку данных для БД.

**Методы:**
- `ProcessImage(imagePath string) (result, debugInfo, jsonData, rawText string, err error)`  
  Выполняет OCR обработку изображения и возвращает все данные.
- `fixMalformedJSON(jsonData string) string`  
  Исправляет JSON с отсутствующими запятыми в массиве structured_data.
- `ParseOCRResult(ocrResult string) (debugInfo, jsonData, rawText string)`  
  Парсит результат OCR и извлекает debug-информацию, JSON и raw_text.

**Особенности:**
- Интеграция с внешним cpp_ocr.exe
- Автоматическое исправление JSON
- Обработка ошибок OCR
- Поддержка структурированных данных

**Зависимости:**
- Конфиг
- Внешний OCR движок

---

## ClickManager

**Назначение:**  
Инкапсулирует работу с Arduino, кликами по координатам, скроллингом и фокусировкой окна.

**Методы:**
- `ClickCoordinates(coordinate image.Point)`  
  Выполняет клик по указанным координатам с учетом отступов.
- `FocusL2Window()`  
  Фокусирует окно L2, кликая по координатам Item1.

**Особенности:**
- Интеграция с Arduino через serial port
- Автоматическое позиционирование мыши
- Поддержка различных типов кликов
- Обработка ошибок связи

**Зависимости:**
- Arduino (через serial port)
- Конфиг

---

## InterruptManager

**Назначение:**  
Управляет прерываниями и сигналами для корректного завершения работы скриптов.

**Методы:**
- `GetScriptInterruptChan() <-chan struct{}`  
  Возвращает канал для получения сигналов прерывания.
- `SetupInterruptHandling()`  
  Настраивает обработку сигналов прерывания.
- `Cleanup()`  
  Очищает ресурсы и закрывает каналы.

**Особенности:**
- Обработка системных сигналов (SIGINT, SIGTERM)
- Глобальные горячие клавиши
- Потокобезопасность
- Graceful shutdown

**Зависимости:**
- Системные сигналы
- Глобальные горячие клавиши

---

## ArduinoManager

**Назначение:**  
Управляет Arduino для автоматизации кликов, скроллинга и других действий.

**Методы:**
- `ClickCoordinates(config *config.Config, coordinate image.Point)`  
  Отправляет команду клика на Arduino.
- `ScrollDown(config *config.Config, steps int)`  
  Отправляет команду скролла вниз.
- `ScrollUp(config *config.Config, steps int)`  
  Отправляет команду скролла вверх.
- `FastClick(config *config.Config)`  
  Выполняет быстрый клик.

**Особенности:**
- Serial связь с Arduino
- Буферизация команд
- Обработка ошибок связи
- Автоматическое переподключение

**Зависимости:**
- Arduino устройство
- Serial порт
- Конфиг

---

## Взаимодействие менеджеров

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  ClickManager   │    │ ScreenshotManager│    │  OCRManager     │
│                 │    │                 │    │                 │
│ - Arduino       │    │ - Качество      │    │ - OCR           │
│ - Клики         │    │ - Координаты    │    │ - JSON          │
│ - Скролл        │    │ - Скролл        │    │ - Структурир.   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │ DatabaseManager │
                    │                 │
                    │ - Асинхронное   │
                    │ - Batch         │
                    │ - Транзакции    │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │ LoggerManager   │
                    │                 │
                    │ - Логирование   │
                    │ - Эмодзи        │
                    │ - Ротация       │
                    └─────────────────┘
```

---

## Конфигурация

Все менеджеры используют централизованную конфигурацию через `config.Config`:

- **Параметры Arduino**: порт, скорость, координаты
- **Параметры скриншотов**: отступы, размеры, качество
- **Параметры БД**: подключение, настройки сохранения
- **Параметры логирования**: пути, уровни, ротация

---

## Как поддерживать документацию в актуальном состоянии

- При добавлении новых менеджеров или методов — обязательно обновляйте этот файл
- Если меняется назначение или зависимости менеджера — отражайте это в описании
- Для сложных методов добавляйте краткое описание логики
- Обновляйте диаграмму взаимодействия при изменении архитектуры
- Добавляйте примеры использования для новых функций 